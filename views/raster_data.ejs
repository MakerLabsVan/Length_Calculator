<!DOCTYPE html>
<html>
<script type="text/javascript" src="/rgbcolor.js"></script> 
<script type="text/javascript" src="/StackBlur.js"></script>
<script type="text/javascript" src="/canvg.js"></script> 
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
  <% include templates/header.ejs %>
    <h2><%= title %>:</h2>
    <p>Membership: <%= membership %></p>
    <p>Naive total time: <%= naiveTime %> minutes</p>
    <p>Naive total cost: $<%= naiveCost %></p>
    <p id="rasterlength"></p> <!-- does NOT take into account jogging, and does not work with shapes or images-->
    <h3 id="time"></h3>
    <h3 id="cost"></h3>
    <canvas id="canvas"></canvas> 
    <script type="text/javascript">
      var ML = {};
      window.onload = function() {
        var ACCELERATION_TIME_PER_INCH = 0.63333; //in minutes
        canvg('canvas', '<%= filename %>');
        var rasterLength = 0;
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        ML.width = canvas.width;
        ML.height = canvas.height;
        ML.data = ctx.getImageData(0, 0, ML.width, ML.height).data;
        console.log(ML.data);
        for(var y = 0; y < ML.height; y++){
          var leftMostPixel = ML.width - 1;
          var rightMostPixel = 0;
          for(var x = 0; x < ML.width; x++){
            if(isColoured(x, y)){
              leftMostPixel = Math.min(x, leftMostPixel);
              rightMostPixel = Math.max(x, rightMostPixel);
            }
          }
          if (rightMostPixel > leftMostPixel){
            rasterLength += rightMostPixel - leftMostPixel;
          }
        }
        rasterLength = rasterLength * (<%= resolution %> / 90) / 90;
        document.getElementById("rasterlength").innerHTML = 'Optimized raster length: ' + rasterLength.toFixed(2) + ' inches';
        var time = (rasterLength / <%= speed %> / 60);
        time = time + ACCELERATION_TIME_PER_INCH * <%= height %>;
        document.getElementById("time").innerHTML = 'Actual time: ' + time.toFixed(2) + ' minutes';
        var cost = time * <%= rate %>;
        if (cost > 15){
          document.getElementById("cost").innerHTML = 'Actual cost: $'+ cost.toFixed(2);
        }
        else{
          document.getElementById("cost").innerHTML = 'Actual cost: $15'; //15 dollar minimum fee
        }
        
      }

      function isColoured(x, y){
        var offset = y * 4 * ML.width + x * 4;
        var red = ML.data[offset];
        var green = ML.data[offset + 1];
        var blue = ML.data[offset + 2];
        var alpha = ML.data[offset + 3];
        if((red === 255 && green === 255 && blue === 255) || alpha === 0){
          return false;
        }
        else{
          return true;
        }
      }

    </script>
  </body>
</html>
