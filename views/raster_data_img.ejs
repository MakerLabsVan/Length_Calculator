<!DOCTYPE html>
<html>
<script type="text/javascript" src="/rgbcolor.js"></script> 
<script type="text/javascript" src="/StackBlur.js"></script>
<script type="text/javascript" src="/canvg.js"></script> 
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"> 
<head>
  <title><%= title %></title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
</head>
<body>
  <% include templates/header.ejs %>

  <div class="container">
    <div class="page-header">
      <h2><%= title %></h2>
    </div>
    <div class="jumbotron">
      <p>Membership: <%= membership %></p>
      <p id="rasterlength"></p> <!-- does NOT take into account jogging, and does not work with shapes or images-->
      <p id="time"></p>
      <p id="cost"></p>
      <canvas id="canvas"></canvas> 
    </div>
  </div>

  <script type="text/javascript">
    var ML = {};
    var loadFunction = function() {
        var ACCELERATION_TIME_PER_INCH = 0.63333; //in minutes
        var rasterLength = 0;
        var imageFileName = "<%= filename %>";
        var fileType = imageFileName.substring(imageFileName.lastIndexOf(".") + 1);

        var image = new Image();
        image.addEventListener("load", function() {
          var canvas = document.getElementById('canvas');
          canvas.width = image.width;
          canvas.height = image.height;
          var ctx = canvas.getContext('2d');
          ctx.drawImage(image, 0, 0, image.width, image.height);
          ML.width = image.width;
          ML.height = image.height;
          ML.data = ctx.getImageData(0, 0, ML.width, ML.height).data;
          for(var y = 0; y < ML.height; y++){
            var leftMostPixel = ML.width - 1;
            var rightMostPixel = 0;
            for(var x = 0; x < ML.width; x++){
              if(isColoured(x, y)){
                leftMostPixel = Math.min(x, leftMostPixel);
                rightMostPixel = Math.max(x, rightMostPixel);
              }
            }
            if (rightMostPixel > leftMostPixel){
              rasterLength += rightMostPixel - leftMostPixel;
            }
          }
          rasterLength = rasterLength * (<%= resolution %> / 90) / 90;
          document.getElementById("rasterlength").innerHTML = 'Optimized raster length: ' + rasterLength.toFixed(2) + ' inches';
          var time = (rasterLength / <%= speed %> / 60);
          console.log("speed: " + <%= speed %>);
          time = time + ACCELERATION_TIME_PER_INCH * (image.height / 90);
          document.getElementById("time").innerHTML = 'Actual time: ' + time.toFixed(2) + ' minutes';
          var cost = time * <%= rate %>;
          if (cost > 15){
            document.getElementById("cost").innerHTML = 'Actual cost: $' + cost.toFixed(2);
          }
          else{
            document.getElementById("cost").innerHTML = 'Actual cost: $15'; //15 dollar minimum fee
          }
        }, false);
image.src = imageFileName;
}   

function isColoured(x, y){
  var offset = y * 4 * ML.width + x * 4;
  var red = ML.data[offset];
  var green = ML.data[offset + 1];
  var blue = ML.data[offset + 2];
  var alpha = ML.data[offset + 3];
  if((red === 255 && green === 255 && blue === 255) || alpha === 0){
    return false;
  }
  else{
    return true;
  }
}
window.onload = loadFunction;
</script>
</body>
</html>
